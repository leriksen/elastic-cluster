{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "active_directory_auth": {
      "type": "String"
    },
    "availability_zone": {
      "type": "String"
    },
    "backup_retention_days": {
      "type": "String"
    },
    "cmk_assigned_identity": {
      "type": "String"
    },
    "cmk_encryption_type": {
      "type": "String"
    },
    "cmk_key_uri": {
      "type": "String"
    },
    "geo_redundant_backup": {
      "type": "String"
    },
    "ha_mode": {
      "type": "String"
    },
    "identity_type": {
      "type": "String"
    },
    "location": {
      "type": "String"
    },
    "name": {
      "type": "String"
    },
    "network": {
      "type": "Object",
      "defaultValue": {}
    },
    "password_auth": {
      "type": "String"
    },
    "sku_name": {
      "type": "String"
    },
    "sku_tier": {
      "type": "String"
    },
    "standby_availability_zone": {
      "type": "String"
    },
    "storage_autogrow": {
      "type": "String"
    },
    "storage_size_gb": {
      "type": "String"
    },
    "tenant_id": {
      "type": "String"
    },
    "version": {
      "type": "String"
    }
  },
  "variables": {},
  "resources": [
    {
      "type"      : "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2025-01-01-preview",
      "name"      : "[parameters('name')]",
      "location"  : "[parameters('location')]",
      "sku": {
        "name": "[parameters('sku_name')]",
        "tier": "[parameters('sku_tier')]"
      },
      "identity": {
        "type": "[parameters('identity_type')]",
        "userAssignedIdentities": {
          "[parameters('cmk_assigned_identity')]": {}
        }
      },
      "properties": {
        "authConfig": {
          "activeDirectoryAuth": "[parameters('active_directory_auth')]",
          "passwordAuth"       : "[parameters('password_auth')]",
          "tenantId"           : "[parameters('tenant_id')]"
        },
        "availabilityZone": "[parameters('availability_zone')]",
        "backup": {
          "backupRetentionDays": "[parameters('backup_retention_days')]",
          "geoRedundantBackup" : "[parameters('geo_redundant_backup')]"
        },
        "createMode": "Default",
        "dataEncryption": {
          "type"                         : "[parameters('cmk_encryption_type')]",
          "primaryKeyURI"                : "[parameters('cmk_key_uri')]",
          "primaryUserAssignedIdentityId": "[parameters('cmk_assigned_identity')]"
        },
        "highAvailability": {
          "mode"                   : "[parameters('ha_mode')]",
          "standbyAvailabilityZone": "[parameters('standby_availability_zone')]"
        },
        "network": "[parameters('network')]",
        "storage": {
          "StorageSizeGB": "[parameters('storage_size_gb')]",
          "Autogrow"     : "[parameters('storage_autogrow')]"
        },
        "version": "[parameters('version')]"
      }
    }
  ],
  "outputs": {
    "id": {
      "type" : "String",
      "value": "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('name'))]"
    },
    "name" : {
      "type" : "String",
      "value": "[parameters('name')]"
    }
  }
}